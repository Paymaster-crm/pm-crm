"use strict";(self.webpackChunkpaymaster_crm=self.webpackChunkpaymaster_crm||[]).push([[3954],{3954:(e,a,r)=>{r.r(a),r.d(a,{default:()=>p});var t=r(9950),n=r(4542),s=r(2436),o=r(9246);var i=r(2986);var c=r(3557),u=r(3939),l=r(9714);const d=l.Ik({username:l.Yj().required("Username is required").min(4,"Username should be at least 4 characters long")});var m=r(4414);function h(e){const{setUser:a}=(0,t.useContext)(s.R),r=(0,t.useRef)(null);(0,t.useEffect)((()=>{r.current&&r.current.focus()}),[]);const l=(0,u.Wx)({initialValues:{username:e.username},validationSchema:d,onSubmit:async r=>{let t;e.setUsername(r.username);try{if(t=await async function(e){try{return(await o.A.post("https://sameer-yadav.online/api/webauthn-credential-check",{username:e},{withCredentials:!0})).data}catch(a){return console.error("Credential check error:",a),!1}}(r.username),!t)return void alert("User not found");if(!t.hasCredentials)return e.setUseWebAuthn(!1),void e.setIsTwoFactorEnabled(t.isTwoFactorEnabled);const s=await async function(e){try{return(await o.A.post("https://sameer-yadav.online/api/webauthn-login-options",{username:e},{withCredentials:!0})).data}catch(a){return console.error("Login options error:",a),null}}(r.username);if(!s)return void e.setUseWebAuthn(!1);const c=((n=s).challenge=new Uint8Array(n.challenge.match(/.{1,2}/g).map((e=>parseInt(e,16)))),n.allowCredentials.forEach((e=>{e.id=new Uint8Array(e.id.data)})),n),u=await async function(e){return await navigator.credentials.get({publicKey:e})}(c),l=function(e){return{id:e.id,type:e.type,rawId:Array.from(new Uint8Array(e.rawId)),response:{authenticatorData:Array.from(new Uint8Array(e.response.authenticatorData)),clientDataJSON:Array.from(new Uint8Array(e.response.clientDataJSON)),signature:Array.from(new Uint8Array(e.response.signature)),userHandle:e.response.userHandle?Array.from(new Uint8Array(e.response.userHandle)):null}}}(u),d=await async function(e,a){try{return(await o.A.post("https://sameer-yadav.online/api/webauthn-verify-login",{username:e,credential:a},{withCredentials:!0})).data.success}catch(r){return console.error("Credential verification error:",r),!1}}(r.username,l);d?await async function(e,a,r){const t=await(0,i.N)();try{const n=await o.A.post("https://sameer-yadav.online/api/webauthn-login",{username:e,geolocation:t,userAgent:navigator.userAgent,credential:a},{withCredentials:!0});"Login successful"===n.data.message?r(n.data.user):alert(n.data.message)}catch(n){console.error("Final login error:",n)}}(r.username,l,a):e.setUseWebAuthn(!1)}catch(s){console.error(s),"NotAllowedError"===s.name?console.log("User canceled the WebAuthn prompt."):console.error(s),t?e.setIsTwoFactorEnabled(t.isTwoFactorEnabled):(console.warn("Could not determine 2FA status, setting to false."),e.setIsTwoFactorEnabled(!1)),e.setUseWebAuthn(!1)}var n}});return(0,m.jsx)(m.Fragment,{children:(0,m.jsxs)("form",{className:"login-form",onSubmit:l.handleSubmit,children:[(0,m.jsx)(n.S,{ref:r,id:"username",name:"username",placeholder:"Username",value:l.values.username,onChange:l.handleChange}),l.touched.username&&l.errors.username&&(0,m.jsx)("small",{className:"p-error",children:l.errors.username}),(0,m.jsx)("br",{}),(0,m.jsx)(c.default,{type:"submit",variant:"outlined",name:"Submit"})]})})}const p=t.memo(h)},2986:(e,a,r)=>{r.d(a,{N:()=>t});const t=async()=>{try{const e=await fetch("https://api.ipify.org?format=json"),a=(await e.json()).ip,r=await fetch(`https://ipapi.co/${a}/json/`),t=await r.json();return{latitude:t.latitude,longitude:t.longitude,ipAddress:a}}catch(e){console.error("Error fetching data:",e)}}}}]);